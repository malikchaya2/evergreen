unset_function_vars: true

#######################################
#              Functions              #
#######################################
functions:
  test-vars:
    - command: expansions.update
      params:
        updates:
          - key: foo
            value: ${foo}
    - command: shell.exec
      params:
        script: |
          echo "value of foo in function before expansion.update '${foo}'"
          echo "expected: function-var"
    - command: expansions.update
      params:
        foo: "the new expansion value 2"
    - command: shell.exec
      params:
        script: |
          echo "value of foo in function after expansions.update '${foo}'"
          echo "expected: function-var"

#######################################
#                Tasks                #
#######################################

tasks:
  - name: chaya-funcs
    commands:
      - command: shell.exec
        params:
          script: |
            echo "value of foo in task before the function ran '${foo}'"
            echo "expected: build-variant-expansion"
      - func: test-vars
        vars:
          foo: "function-var"
      - command: shell.exec
        params:
          script: |
            echo "value of foo in task after the function ran '${foo}'"
            echo "expected: function-var"

#######################################
#            Buildvariants            #
#######################################
buildvariants:
  - name: lint
    display_name: Lint
    run_on:
      - ubuntu2204-small
      - ubuntu2204-large
    expansions:
      foo: "build-variant-expansion"
      GOROOT: /opt/golang/go1.20
    tasks:
      - name: "chaya-funcs"
